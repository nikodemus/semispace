<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>Semispace Comet Demo</title>
    <!--
        /**
         * Copyright 2010 Trygve Lie
         *
         * Licensed under the Apache License, Version 2.0 (the "License");
         * you may not use this file except in compliance with the License.
         * You may obtain a copy of the License at
         *
         *   http://www.apache.org/licenses/LICENSE-2.0
         *
         * Unless required by applicable law or agreed to in writing, software
         * distributed under the License is distributed on an "AS IS" BASIS,
         * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
         * See the License for the specific language governing permissions and
         * limitations under the License.
         **/
    -->

    <link href="../resources/style.css" type="text/css" rel="stylesheet" media="all" title="Example styling" />

    <!-- DOJO kit -->
    <script type="text/javascript" src="/semispace-comet-server/js/lib/dojo-release-1.4.2/dojo/dojo.js"> </script>

    <!-- SemiSpace -->
    <script type="text/javascript" src="/semispace-comet-server/js/semispace.js"> </script>
    <script type="text/javascript" src="/semispace-comet-server/js/core/semispace.Comet.js"> </script>
    <script type="text/javascript" src="/semispace-comet-server/js/core/semispace.SemiSpace.js"> </script>

    <!-- Example -->
    <script type="text/javascript" src="../resources/helpers.js"> </script>
    <script type="text/javascript">

        // Set local logger
        var localLog = function(status, message){
            var msg = 'Status is: ' + status;
            switch(status){
                case 1:
                    msg = msg + ' - Handshake is done';
                    break;
                case 2:
                    msg = msg + ' - Got connection to server';
                    break;
                case 3:
                    msg = msg + ' - No connection to server';
                    break;
                case 4:
                    msg = msg + ' - Comunicating with server';
                    break;
                case 5:
                    msg = msg + ' - Is disconnected';
                    break;
                case 6:
                    msg = msg + ' - Subscribed to channel';
                    break;
                case 7:
                    msg = msg + ' - Unsubscribed to channel';
                    break;
                case 8:
                    msg = msg + ' - A publish is performed';
                    break;
                case 9:
                    msg = msg + ' - Unsuccessful to communicate with server';
                    break;
                default:
                    msg = msg + ' - Unknown!';
            }
            logger('log', msg);
        };

        var callbackRead = function(message){
            alert('Hello read: ' + message);
        };

        var callbackWrite = function(message){
            alert('Hello write: ' + message);
        };

        var callbackGeneric = function(message){
            alert('Hello Generic: ' +  message);
        };

        var callbackNotify = function(message){
            alert('Hello from Notify');
        };

        // Where the server is
        var server = location.protocol + '//' + location.host + '/semispace-comet-server/cometd';

        // Get DOJO cometd library
        dojo.require("dojox.cometd");
        var com = dojox.cometd;

        var jsonString = JSON.stringify({"Person":{"firstName":"John","lastName":"Doe"}});
        var jsonTemplate = JSON.stringify({"Person":{"firstName":"John"}});

        var leaseFunction;
        var myApp;
        var semiApp;
        var init = function(){
            myApp = new semispace.Comet(com, server);
            myApp.addMetaListener(localLog);
            semiApp = new semispace.SemiSpace(myApp.getConnection());
        };

        var start = function(){
            myApp.connect();

        };

        var stop = function(){
            myApp.disconnect();
        };


        var wrte = function(){
            semiApp.write(jsonString, 60000, callbackWrite);
        };


        var read = function(){
            semiApp.read(jsonTemplate, 60000, callbackRead);
        };

        /*
        var read = function(){
            semiApp.read(jsonTemplate, 60000);
        };
        */

        var readIfExists = function(){
            semiApp.readIfExists(jsonTemplate, callbackRead);
        };

        var take = function(){
            semiApp.take(jsonTemplate, 60000,callbackGeneric);
        };

        var takeIfExists = function(){
            semiApp.takeIfExists(jsonTemplate, callbackGeneric);
        };

        var notify = function(){
            leaseFunction = semiApp.notify(jsonTemplate, 'availability', 600000, callbackNotify);
            //leaseFunction = semiApp.notify(jsonTemplate, 'all', 600000, callbackGeneric);
            //console.log('Impl Notify: ' + leaseFunction);
        };

        var tuddelu = function(){
            alert('kidding');
        };

        var lease = function(){
            leaseFunction();
            //alert(leaseFunction);
            //console.log('Impl Lease: ' + leaseFunction);
            //semiApp.jalla(leaseFunction);
        };

        var chaining = function(){
            semiApp.read(jsonTemplate, 60000).write(jsonString, 60000, callbackGeneric);
        };


        var batch = function(){
            /*
            myApp.batch(function(){
                myApp.rSubscribe();
                myApp.wSubscribe();
            });
            */

        };
    </script>
</head>
<body onload="init();">
    <h1>SemiSpace CometD - Example 01</h1>
    <div id="result">
        <a href="javascript:;" onclick="start();">Connect to server</a> |
        <a href="javascript:;" onclick="stop();">Disconnect from server</a> |
        <a href="javascript:;" onclick="wrte();">Write</a> |
        <a href="javascript:;" onclick="read();">Read</a> |
        <a href="javascript:;" onclick="readIfExists();">Read If Exists</a> |
        <a href="javascript:;" onclick="take();">Take</a> |
        <a href="javascript:;" onclick="takeIfExists();">Take If Exists</a> |
        <a href="javascript:;" onclick="notify();">Notify</a> |
        <a href="javascript:;" onclick="lease();">Lease Cancel</a> |
        <a href="javascript:;" onclick="chaining();">Chaining</a>
    </div>
    <div id="log"> </div>
</body>
</html>