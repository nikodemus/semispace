<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>Semispace Example 02</title>
    <!--
        /**
         * Copyright 2010 Trygve Lie
         *
         * Licensed under the Apache License, Version 2.0 (the "License");
         * you may not use this file except in compliance with the License.
         * You may obtain a copy of the License at
         *
         *   http://www.apache.org/licenses/LICENSE-2.0
         *
         * Unless required by applicable law or agreed to in writing, software
         * distributed under the License is distributed on an "AS IS" BASIS,
         * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
         * See the License for the specific language governing permissions and
         * limitations under the License.
         **/
    -->

    <link href="style.css" type="text/css" rel="stylesheet" media="all" title="Example styling" />

    <!-- Semispace Comet Scripts -->
    <script type="text/javascript" src="/semispace-comet-server/dojo/dojo.js.uncompressed.js"> </script>
    <script type="text/javascript" src="http://localhost:8080/semispace-comet-server/js/semispace.js"> </script>
    <script type="text/javascript" src="http://localhost:8080/semispace-comet-server/js/util/semispace.util.js"> </script>
    <script type="text/javascript" src="http://localhost:8080/semispace-comet-server/js/util/semispace.util.interface.js"> </script>
    <script type="text/javascript" src="http://localhost:8080/semispace-comet-server/js/interfaces/semispace.SemiSpaceInterface.js"> </script>
    <script type="text/javascript" src="http://localhost:8080/semispace-comet-server/js/core/semispace.Comet.js"> </script>
    <script type="text/javascript" src="http://localhost:8080/semispace-comet-server/js/core/semispace.SemiSpace.js"> </script>

    <!-- Example -->
    <script type="text/javascript">

        /*
            How:
             - On Load
                X Check space for data
                    X If data; read data
                        X update local storage
                        X update page
                            - keep local editeble element
                            - lock foreign elements
                    X If no data; do nothing
                - Attach to notify

            - On notify
                - read data
                    - update local storage
                    - update page
                        - keep local editeble element
                        - lock foreign elements

            - On edit
                - apply element to local storage
                    - add current element to array
                - take data from space
                - write data to space

            - On save
                - remove element to local storage
                    - remove current element from array
                - take data from space
                - write data to space

        */

        var example = {

            user:Math.floor(Math.random()*24),

            pageTemplate:{
                "page" : {
                    "id" : "someid"
                }
            },

/*
            pageLock:{
                "page" : {
                    "id" : "someid",
                    "locks" : [
                        {
                            "id" : "edit1",
                            "status" : "open",
                            "user" : "open"
                        },
                        {
                            "id" : "edit2",
                            "status" : "open",
                            "user" : "open"
                        }
                    ]
                }
            },
*/


            pageLock:{
                "page" : {
                    "id" : "someid",
                    "locks" : [
                        {
                            "id" : "hack",
                            "user" : "hack"
                        },
                        {
                            "id" : "hack",
                            "user" : "hack"
                        }
                    ]
                }
            },


            comet:undefined,

            init:function(){
                dojo.require("dojox.cometd");
                this.comet = dojox.cometd;
                example.dom.parseDomAndSetEditFunctions();
                example.server.load();
                //example.dom.lock();
            }
        };

        example.dom = {

            parseDomAndSetEditFunctions:function(){
                var elements = document.getElementsByTagName('a');
                var i = elements.length;
                while(i--){
                    elements[i].onclick = function(){
                        example.dom.doEdit(this);
                    };
                }
            },

            doEdit:function(el){
                var sibling = el.parentNode.parentNode;
                el.innerHTML = '[save]';
                sibling.className = 'editing';

                el.onclick = function(){
                    example.dom.doSave(this);
                };

                //example.pageLock.page.locks.push({"id" : sibling.id, "user" : example.user});
                example.pageLock.page.locks.push({"id" : sibling.id, "user" : example.user});

                var pageTemplateAsString = JSON.stringify(example.pageTemplate);
                example.server.Lock.takeIfExists(pageTemplateAsString, function(){
                    // Do nothing
                });

                var pageLockAsString = JSON.stringify(example.pageLock);
                example.server.Lock.write(pageLockAsString, 6000000, function(){
                    // Do nothing
                });

            },

            doSave:function(el){
                var sibling = el.parentNode.parentNode;
                sibling.className = '';
                el.innerHTML = '[edit]';

                el.onclick = function(){
                    example.dom.doEdit(this);
                };



            },

            lock:function(){
                var i = example.pageLock.page.locks.length;
                while(i--){
                    var obj = example.pageLock.page.locks[i];
                    // Exclude hack to avoid one element array bug
                    if(obj.id !== 'hack'){
                        var el = document.getElementById(obj.id);
                        if(obj.user === example.user){
                            el.className = 'editing'; // TODO: Set own for in edit mode by same user!!
                        }else{
                            el.className = 'locked';
                        }
                    }
                }

            }
        };

        example.server = {

            Connection:undefined,
            Lock:undefined,

            load:function(){
                //var g = JSON.stringify(example.pageLock);
                //var k = JSON.parse(g);
                //example.pageLock.page.locks.push('jalla');
                //alert(example.pageLock.page.locks.length);

                var host = location.protocol + '//' + location.host + '/semispace-comet-server/cometd';
                this.Connection = new semispace.Comet(example.comet,host);
                this.Lock = new semispace.SemiSpace(this.Connection.getConnection());

                this.Connection.connect();

                var pageTemplateAsString = JSON.stringify(example.pageTemplate);
                example.server.Lock.readIfExists(pageTemplateAsString, example.server.jalla);
            },

            jalla:function(JSONAsString){
                if(JSONAsString){
                    example.pageLock = JSON.parse(JSONAsString);
                    example.dom.lock();
                }
            }

        };

    </script>
</head>
<body onload="example.init();">

<div class="page">

    <div class="row d_100">
        <div class="col d_100"><div class="el c3"> </div></div>
        <div class="col d_25">
            <div id="edit1" class="el c1">
                <div><a href="javascript:;">[edit]</a></div>
            </div>
        </div>
        <div class="col d_25">
            <div id="edit2" class="el c2">
                <div><a href="javascript:;">[edit]</a></div>
            </div>
        </div>
        <div class="col d_25"><div class="el c5"> </div></div>
        <div class="col d_25"><div class="el c6"> </div></div>

        <div class="col d_100"><div class="el c4"> </div></div>
        <div class="col d_50"><div class="el c7"> </div></div>
        <div class="col d_50"><div class="el c8"> </div></div>
    </div>

    <div class="row d_50">
        <div class="col d_100"><div class="el c1"> </div></div>

        <div class="col d_50"><div class="el c2"> </div></div>
        <div class="col d_50"><div class="el c3"> </div></div>
        <div class="col d_40"><div class="el c4"> </div></div>
        <div class="col d_20"><div class="el c5"> </div></div>
        <div class="col d_40"><div class="el c6"> </div></div>
    </div>

    <div class="row d_50">
        <div class="col d_100"><div class="el c1"> </div></div>
        <div class="col d_30"><div class="el c2"> </div></div>
        <div class="col d_40"><div class="el c3"> </div></div>
        <div class="col d_30"><div class="el c4"> </div></div>
        <div class="col d_80"><div class="el c5"> </div></div>

        <div class="col d_20"><div class="el c6"> </div></div>
    </div>

    <div class="row d_100">
        <div class="col d_100"><div class="el c1"> </div></div>
        <div class="col d_30"><div class="el c2"> </div></div>
        <div class="col d_70"><div class="el c3"> </div></div>

        <div class="col d_40"><div class="el c4"> </div></div>
        <div class="col d_20"><div class="el c5"> </div></div>
        <div class="col d_40"><div class="el c6"> </div></div>
    </div>

</div>

</body>
</html>